name: NixOS Configuration CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main", "REFACTORv2"]
  workflow_dispatch:

jobs:
  # ==========================================
  # Job 1: Flake Check
  # ==========================================
  flake-check:
    name: Nix Flake Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true
      
      - name: Run flake check
        run: |
          echo "::group::Flake Check"
          nix flake check --accept-flake-config --show-trace 2>&1 | tee flake-check.log
          echo "::endgroup::"
        continue-on-error: true
      
      - name: Upload flake check log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flake-check-log
          path: flake-check.log
          retention-days: 7

  # ==========================================
  # Job 2: Build Configurations
  # ==========================================
  build-configs:
    name: Build ${{ matrix.host }}
    runs-on: ubuntu-latest
    needs: flake-check
    if: always()
    
    strategy:
      fail-fast: false
      matrix:
        host:
          - macbook
          - dell
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            # Allow insecure packages for Dell (broadcom-sta)
            allow-insecure = true
      
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        continue-on-error: true
      
      - name: Build NixOS configuration
        run: |
          echo "::group::Building ${{ matrix.host }} configuration"
          nix build .#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel \
            --accept-flake-config \
            --show-trace \
            --print-build-logs \
            2>&1 | tee build-${{ matrix.host }}.log
          echo "::endgroup::"
        continue-on-error: true
      
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.host }}
          path: build-${{ matrix.host }}.log
          retention-days: 7

  # ==========================================
  # Job 3: Eval Devshells
  # ==========================================
  eval-devshells:
    name: Evaluate Devshells
    runs-on: ubuntu-latest
    needs: flake-check
    if: always()
    
    strategy:
      fail-fast: false
      matrix:
        shell:
          - default
          - rust
          - rust-nightly
          - go
          - lua
          - nix-dev
          - fullstack
          - devops
          - postgresql
          - mariadb
          - sqlite
          - databases
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      
      - name: Evaluate devshell
        run: |
          echo "::group::Evaluating devshell: ${{ matrix.shell }}"
          nix develop .#${{ matrix.shell }} --command echo "âœ… Devshell ${{ matrix.shell }} OK"
          echo "::endgroup::"

  # ==========================================
  # Job 4: Nix Format Check
  # ==========================================
  format-check:
    name: Nix Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      
      - name: Run nix fmt
        run: |
          echo "::group::Running nix fmt"
          nix fmt
          echo "::endgroup::"
      
      - name: Check for formatting changes
        id: format-changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "::warning::Files were reformatted by nix fmt"
            git diff
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âœ… All files are properly formatted"
          fi
      
      - name: Commit formatting changes
        if: steps.format-changes.outputs.changes == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "style: auto-format Nix files with nixpkgs-fmt [skip ci]"
          git push

  # ==========================================
  # Job 5: Summary Report
  # ==========================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [flake-check, build-configs, eval-devshells, format-check]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ” NixOS Configuration CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Flake Check | ${{ needs.flake-check.result == 'success' && 'âœ… Passed' || needs.flake-check.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Configs | ${{ needs.build-configs.result == 'success' && 'âœ… Passed' || needs.build-configs.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Devshells | ${{ needs.eval-devshells.result == 'success' && 'âœ… Passed' || needs.eval-devshells.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.format-check.result == 'success' && 'âœ… Passed' || needs.format-check.result == 'failure' && 'âŒ Failed' || 'âš ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
