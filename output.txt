----
.editorconfig

root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.nix]
indent_style = space
indent_size = 2

----
.github/workflows/nixos-ci.yaml

name: NixOS Build Validation

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build (${{ matrix.profile }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        profile:
          - dell
          - macbook

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Evaluate configuration
        run: |
          nix-instantiate '<nixpkgs/nixos>' \
            -A system \
            -I nixos-config=$(pwd) \
            > /dev/null

      - name: Dry build
        run: |
          nix-shell -p nixos-rebuild --run "
            nixos-rebuild build \
              -I nixos-config=$(pwd) \
              --dry-run
          "

      - name: Build summary
        if: always()
        run: |
          {
            echo "## ðŸ—ï¸ Build Summary"
            echo ""
            echo "- Profile: **${{ matrix.profile }}**"
            echo "- Evaluation: OK"
            echo "- Dry build: OK"
          } >> $GITHUB_STEP_SUMMARY

----
.github/workflows/nixos-lint.yaml

name: NixOS Lint

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  lint:
    name: Lint Nix files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: nixfmt check
        run: |
          nix-shell -p nixfmt-rfc-style --run '
            find . -name "*.nix" \
              ! -name "hardware-configuration-*.nix" \
              -print0 \
            | xargs -0 nixfmt --check
          '

      - name: statix
        run: nix-shell -p statix --run "statix check ."

      - name: deadnix
        run: |
          nix-shell -p deadnix --run '
            deadnix \
              --exclude hardware-configuration-dell.nix \
              --exclude hardware-configuration-macbook.nix \
              .
          '

      - name: Lint summary
        if: always()
        run: |
          {
            echo "## ðŸ§¹ Lint Summary"
            echo ""
            echo "- nixfmt: checked"
            echo "- statix: checked"
            echo "- deadnix: checked"
          } >> $GITHUB_STEP_SUMMARY

----
.github/workflows/nixos-nightly.yaml

name: NixOS Nightly Channel Check

on:
  schedule:
    - cron: "0 3 * * *"   # Daily at 03:00 UTC
  workflow_dispatch:

jobs:
  nightly:
    name: Nightly evaluation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Channel update
        run: |
          nix-channel --add https://nixos.org/channels/nixos-unstable nixpkgs-unstable || true
          nix-channel --update

      - name: Evaluate system
        run: |
          nix-instantiate '<nixpkgs/nixos>' \
            -A system \
            -I nixos-config=$(pwd) \
            > /dev/null

      - name: Nightly summary
        if: always()
        run: |
          {
            echo "## ðŸŒ™ Nightly CI"
            echo ""
            echo "- Channel: nixos-unstable"
            echo "- Evaluation: OK"
            echo "- Purpose: regression detection"
          } >> $GITHUB_STEP_SUMMARY

----
ARCHITECTURE.md

# ARCHITECTURE.md

# NixOS System Architecture

This document describes the architectural design of this NixOS configuration repository.
It focuses on structure, responsibility boundaries, and long-term maintainability.

The goal is to make the system easy to understand, modify, and rebuild on any supported machine.

---

## Architectural Principles

- Single entrypoint
- Explicit imports
- Clear separation of concerns
- Hardware-aware but hardware-isolated
- Declarative over imperative
- Repo-based rebuilds (no /etc/nixos)
- Disposable systems by design

This repository assumes the system can be destroyed and rebuilt at any time.

---

## High-Level Design

The architecture follows a layered model:

1. Entry point
2. Host identity
3. Hardware definition
4. Core system
5. Desktop
6. Containers and virtualization
7. Users
8. Maintenance

Each layer only depends on layers below it.

---

## Entrypoint Layer

### configuration.nix

This is the only entrypoint.

Responsibilities:
- Import modules
- Select host profile
- Select hardware configuration
- Define system.stateVersion

Non-responsibilities:
- No logic
- No hardware tuning
- No package lists
- No user configuration

configuration.nix is wiring only.

---

## Host Identity Layer

### profiles/*.nix

Each profile defines:
- networking.hostName
- Bootloader type and configuration

Examples:
- Legacy BIOS (GRUB)
- EFI (systemd-boot)

Only one profile must be imported at a time.

Profiles never define:
- Packages
- Users
- Services

---

## Hardware Layer

### hardware-configuration-*.nix

- Generated by nixos-generate-config
- Disk layout
- Filesystems
- Kernel modules
- CPU microcode

These files must never be edited manually.

### modules/hardware/*.nix

Vendor-specific hardware tuning:
- Firmware
- Wireless drivers
- Kernel blacklists
- Vendor quirks

Hardware modules must not define:
- Desktop environment
- Users
- Applications

---

## Core System Layer

### modules/base.nix

Defines system fundamentals:
- Locale
- Timezone
- Console keymap
- Nix experimental features

### modules/networking.nix

- NetworkManager
- Faster boot by disabling wait-online

### modules/audio.nix

- PipeWire stack
- PulseAudio disabled
- ALSA enabled

### modules/fonts.nix

- System-wide fonts
- Fontconfig defaults

These modules are hardware-agnostic.

---

## Desktop Layer

### modules/desktops/gnome.nix

Defines:
- X server
- Display manager
- Desktop environment
- Wayland configuration
- Portals

### modules/autologin.nix

- Automatic graphical login
- TTY conflict prevention

Only one desktop module should be active.

Desktop modules must not:
- Install developer tools
- Define users
- Manage containers

---

## Application Layer

### modules/system-packages.nix

Defines all global packages:
- Development toolchains
- Editors and IDEs
- CLI utilities
- Browsers
- Container tooling

Packages are:
- System-wide
- Declarative
- Reproducible

No per-user packages are defined here.

---

## Containers and Virtualization Layer

### Docker

- Enabled as a system service
- Boot-time activation
- User group integration

### Podman

- Rootless
- Docker-compatible
- Disabled by default
- Explicit migration path

### K3s

- Single-node Kubernetes
- Server role
- Minimal components
- Firewall-aware

### Libvirt

- QEMU/KVM
- virt-manager support
- Polkit integration

---

## User Layer

### modules/users/borba.nix

Defines:
- User account
- Shell
- Groups
- Sudo rules

Does not manage:
- Dotfiles
- Editor configuration
- Shell configuration

Dotfiles are managed externally via GNU Stow.

---

## Maintenance Layer

Maintenance is intentionally explicit and manual.

There is no hidden automation that mutates the system unexpectedly.

Maintenance tasks are exposed via:
- Makefile
- nixos-rebuild
- nix-collect-garbage

---

## Rebuild Model

- Repository lives in $HOME/nixos-config
- No symlinks to /etc/nixos
- Rebuilds reference repo path explicitly
- System is always built from the repo state

---

## Failure Model

This system assumes failure is acceptable.

If something breaks:
- Roll back generation
- Fix config
- Rebuild

No mutable state is relied upon.

---

## Summary

This architecture favors:
- Clarity over cleverness
- Explicitness over automation
- Rebuildability over persistence

If you can delete the system and rebuild it without fear, the architecture is correct.

Version: v1.0

----
OPERATIONS.md

# OPERATIONS.md

# Day-2 Operations Guide

This document describes day-2 operational tasks for this NixOS system.
It focuses on maintenance, upgrades, recovery, and diagnostics.

All operations assume the repository lives at:

$HOME/nixos-config

---

## Core Rule

Never edit the running system directly.

All changes must be made in the repository and applied via rebuild.

---

## Common Operations

### Rebuild and Switch

Apply current configuration:

make switch

Build without switching:

make build

Rollback to previous generation:

make rollback

---

## System Updates

### Update Nix Channels

Update channels (including unstable):

make channels

Then rebuild:

make switch

---

## Garbage Collection

### Soft Cleanup

Remove old generations older than 7 days:

make gc-soft

### Hard Cleanup

Aggressive cleanup:

make gc-hard

Use hard GC only when disk space is critically low.

---

## Store Maintenance

### Optimize Store

Deduplicate store paths:

make optimise

### Verify Store Integrity

Check for corruption:

make verify

---

## Disk Space Management

Check disk usage:

make space

Inspect store size:

du -sh /nix/store

List generations:

make generations

Delete old generations manually if required:

sudo nix-env --delete-generations old --profile /nix/var/nix/profiles/system

---

## Diagnostics

Run system diagnostics:

make doctor

Doctor checks:
- Nix availability
- Active system generation
- GC timers
- Docker and K3s status
- Store size

---

## Container Operations

### Docker

Check status:

systemctl status docker

Restart Docker:

sudo systemctl restart docker

### Podman

Ensure Docker is disabled before enabling Podman.

Switch requires editing configuration and rebuilding.

### K3s

Check status:

systemctl status k3s

Kubeconfig location:

/etc/rancher/k3s/k3s.yaml

---

## Virtualization

Check libvirt:

systemctl status libvirtd

User must belong to libvirtd group.

virt-manager is the primary GUI.

---

## Kernel and Boot Issues

List available generations:

sudo nix-env --list-generations --profile /nix/var/nix/profiles/system

Reboot into an older generation via boot menu if system does not start.

---

## Recovery Procedure

If the system fails to boot:

1. Select a previous generation in the bootloader
2. Boot successfully
3. Fix configuration in repo
4. Run make switch

If the system is completely broken:

1. Boot from NixOS installer
2. Mount disks
3. Chroot if necessary
4. Clone repo
5. Rebuild system

---

## Adding New Software

Never install software imperatively.

Do not use:
- nix-env -i
- nix profile install

Always:
- Edit modules/system-packages.nix
- Rebuild

---

## Removing Software

Remove packages from system-packages.nix.
Rebuild.
Run garbage collection if needed.

---

## Hardware Changes

When moving to new hardware:

1. Generate new hardware-configuration.nix
2. Create or adjust hardware module
3. Select appropriate profile
4. Rebuild

---

## Backups

This repository is the backup.

Ensure it is:
- Committed
- Pushed
- Versioned

Optional:
- Back up /home separately

---

## Operational Philosophy

- Rebuilds are cheap
- Rollbacks are safe
- State is disposable
- Configuration is the source of truth

If a fix cannot be expressed declaratively, it is not acceptable.

---

Version: v1.0

----
configuration.nix

{ config, pkgs, ... }:

{
imports = [

  ##########################################
  # Host profile (choose ONE)
  ##########################################
  ./profiles/dell.nix
  # ./profiles/macbook.nix

  ##########################################
  # Hardware
  ##########################################
  ./hardware-configuration-dell.nix
  ./modules/hardware/dell.nix

  ##########################################
  # Core system
  ##########################################
  ./modules/base.nix
  ./modules/networking.nix
  ./modules/audio.nix
  ./modules/fonts.nix
  ./modules/kernel-tuning.nix

  ##########################################
  # Desktop
  ##########################################
  ./modules/desktops/gnome.nix
  ./modules/autologin.nix

  ##########################################
  # Containers / Virtualization
  ##########################################
  ./modules/containers/docker.nix
  ./modules/containers/k3s.nix
  ./modules/virtualization/libvirt.nix

  ##########################################
  # Users / Packages / Nix
  ##########################################
  ./modules/users/borba.nix
  ./modules/system-packages.nix
  ./modules/nixpkgs.nix

  ##########################################
  # Maintenance
  ##########################################
  ./modules/maintenance.nix
  ./modules/maintenance-hm.nix
];


  ############################################
  # System state version
  ############################################
  system.stateVersion = "25.11";
}

----
hardware-configuration-dell.nix

# Do not modify this file!  It was generated by â€˜nixos-generate-configâ€™
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "ehci_pci" "ahci" "ums_realtek" "usb_storage" "sd_mod" "sr_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
      fsType = "ext4";
    };

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

----
hardware-configuration-macbook.nix

# Do not modify this file!  It was generated by â€˜nixos-generate-configâ€™
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "ehci_pci" "ahci" "ums_realtek" "usb_storage" "sd_mod" "sr_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
      fsType = "ext4";
    };

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

----
modules/audio.nix

{ ... }:
{
  services.pulseaudio.enable = false;
  security.rtkit.enable = true;

  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
  };
}

----
modules/autologin.nix

{ ... }:

{
  services.displayManager.autoLogin = {
    enable = true;
    user = "borba";
  };

  # Prevent TTY race with graphical session
  systemd.services."getty@tty1".enable = false;
  systemd.services."autovt@tty1".enable = false;
}

----
modules/base.nix

{ pkgs, ... }:
{
  nix.extraOptions = ''
    experimental-features = nix-command flakes
  '';

  time.timeZone = "America/Sao_Paulo";

  i18n.defaultLocale = "en_US.UTF-8";
  i18n.extraLocaleSettings = {
    LC_ADDRESS = "pt_BR.UTF-8";
    LC_IDENTIFICATION = "pt_BR.UTF-8";
    LC_MEASUREMENT = "pt_BR.UTF-8";
    LC_MONETARY = "pt_BR.UTF-8";
    LC_NAME = "pt_BR.UTF-8";
    LC_NUMERIC = "pt_BR.UTF-8";
    LC_PAPER = "pt_BR.UTF-8";
    LC_TELEPHONE = "pt_BR.UTF-8";
    LC_TIME = "pt_BR.UTF-8";
  };

  console.keyMap = "br-abnt2";
}

----
modules/containers/docker.nix

{ lib, ... }:

{
  virtualisation.docker = {
    enable = true;
    enableOnBoot = true;
  };
}

----
modules/containers/k3s.nix

{ config, pkgs, ... }:

{
  ############################################
  # K3s (single-node workstation cluster)
  ############################################
  services.k3s = {
    enable = true;
    role = "server";

    extraFlags = [
      "--write-kubeconfig-mode=644"
      "--disable=traefik"
      "--disable=servicelb"
    ];
  };

  ############################################
  # Firewall
  ############################################
  networking.firewall.allowedTCPPorts = [
    6443 # Kubernetes API
  ];
}

----
modules/containers/podman.nix

{ config, pkgs, ... }:

{
  ####################################################################
  # Podman (FUTURE USE)
  #
  # This configuration is intentionally DISABLED.
  #
  # Planned migration path:
  # 1. Disable Docker:
  #    virtualisation.docker.enable = false;
  #
  # 2. Enable Podman below and rebuild.
  #
  # Notes:
  # - dockerCompat MUST NOT be enabled together with Docker.
  # - This setup is rootless and Docker-CLI compatible.
  ####################################################################

  # virtualisation.podman = {
  #   enable = true;
  #
  #   # Docker-compatible CLI and socket
  #   dockerCompat = true;
  #
  #   # Default bridge with DNS enabled
  #   defaultNetwork.settings = {
  #     dns_enabled = true;
  #   };
  # };

  # Required for rootless Podman
  # users.users.borba.linger = true;

  # Firewall exception for Podman bridge
  # networking.firewall.trustedInterfaces = [
  #   "podman0"
  # ];
}

----
modules/desktops/gnome.nix

{ pkgs, ... }:

{
  services.xserver.enable = true;

  services.displayManager.gdm = {
    enable = true;
    wayland = true;
  };

  services.desktopManager.gnome.enable = true;

  # Disable unnecessary GNOME services and animations
  services.gnome = {
    core-utilities.enable = true;
    gnome-keyring.enable = true;
  };

  environment.sessionVariables = {
    # Wayland native
    XDG_SESSION_TYPE = "wayland";
    QT_QPA_PLATFORM = "wayland";
    MOZ_ENABLE_WAYLAND = "1";
    NIXOS_OZONE_WL = "1";

    # Reduce frame scheduling overhead
    MUTTER_DEBUG_DISABLE_HW_CURSORS = "1";
  };

  # Portals (required for Wayland apps)
  xdg.portal = {
    enable = true;
    extraPortals = with pkgs; [
      xdg-desktop-portal-gnome
      xdg-desktop-portal-gtk
    ];
  };
}

----
modules/fonts.nix

{ pkgs, ... }:

{
  ############################################
  # Fonts
  ############################################
  fonts = {
    packages = with pkgs; [
      nerd-fonts.jetbrains-mono
    ];

    fontconfig = {
      enable = true;

      defaultFonts = {
        monospace = [ "JetBrainsMono Nerd Font" ];
      };
    };
  };
}

----
modules/hardware/dell.nix

{ pkgs, ... }:
{
  hardware.enableRedistributableFirmware = true;

  networking.enableB43Firmware = true;

  boot.blacklistedKernelModules = [ "brcmsmac" "wl" ];

  environment.systemPackages = with pkgs; [
    b43-firmware-legacy
    b43-fwcutter
    wirelesstools
    rfkill
  ];


}

----
modules/hardware/macbook.nix

{ pkgs, ... }:
{
  hardware.enableRedistributableFirmware = true;

  networking.enableB43Firmware = true;

  boot.blacklistedKernelModules = [ "brcmsmac" "wl" ];

  environment.systemPackages = with pkgs; [
    b43-firmware-legacy
    b43-fwcutter
    wirelesstools
    rfkill
  ];


}

----
modules/networking.nix

{ ... }:
{
  networking.networkmanager.enable = true;

  systemd.services.NetworkManager-wait-online.enable = false;
}

----
modules/nixpkgs.nix

{ ... }:
{
  nixpkgs.overlays = [
    (final: prev: {
      unstable = import <nixpkgs-unstable> {
        config.allowUnfree = true;
      };
    })
  ];
}

----
modules/system-packages.nix

{ pkgs, ... }:

let
  unstable = pkgs.unstable or pkgs;
in
{
  environment.systemPackages = with pkgs; [

    ##########################################
    # Terminals
    ##########################################
    alacritty          # GPU-accelerated terminal
    kitty              # Feature-rich terminal
    gnome-console      # GNOME default terminal

    ##########################################
    # Shells & Multiplexers
    ##########################################
    zsh                # Primary shell
    fish               # Alternative shell
    tmux               # Terminal multiplexer
    tmuxifier          # tmux session manager
    zellij             # Modern tmux alternative

    ##########################################
    # Editors & Development UX
    ##########################################
    unstable.neovim    # Neovim (unstable for faster updates)
    helix              # Modal editor, LSP-first
    unstable.vscode
    unstable.vscode-extensions.ms-vscode-remote.remote-containers

    ##########################################
    # Git & Developer Workflow
    ##########################################
    git
    gh                 # GitHub CLI
    lazygit            # TUI for git
    commitizen         # Conventional commits helper
    devcontainer       # Dev container tooling

    ##########################################
    # Notes / Knowledge Base
    ##########################################
    unstable.obsidian

    ##########################################
    # Containers / Virtualization / Kubernetes
    ##########################################
    docker
    docker-compose
    docker-buildx
    lazydocker
    podman
    podman-compose
    buildah
    skopeo
    cri-tools
    k9s

    virt-manager
    virt-viewer
    qemu
    virtio-win
    spice
    spice-gtk
    spice-protocol

    ##########################################
    # Languages / Toolchains
    ##########################################
    gcc
    libgcc
    glibc
    libcxx
    go
    gopls
    rustup
    rust-analyzer

    ##########################################
    # Build & Debug Tooling
    ##########################################
    cmake
    gnumake
    libtool
    libvterm
    unstable.gdb
    unstable.clang
    unstable.llvm
    unstable.lld

    ##########################################
    # Nix Tooling
    ##########################################
    nixd               # Nix language server
    nil                # Alternative Nix LSP
    statix             # Static analysis for Nix
    deadnix            # Find unused Nix code
    nixfmt-rfc-style   # Nix formatter

    ##########################################
    # Modern CLI Utilities (Shell-first / DevOps)
    ##########################################
    eza                # ls replacement
    bat                # cat replacement
    fd                 # find replacement
    ripgrep            # grep replacement
    yazi               # Terminal file manager
    dust               # du replacement
    ncdu               # Disk usage analyzer
    zoxide             # Smarter cd
    atuin              # Shell history with sync
    tldr               # Simplified man pages
    sd                 # sed replacement
    jq                 # JSON processor
    fx                 # Interactive JSON viewer
    httpie             # Modern HTTP client
    curlie             # curl + httpie hybrid
    fzf                # Fuzzy finder
    direnv             # Per-directory environments
    entr               # Run commands on file changes
    procs              # ps replacement
    bottom             # Advanced system monitor
    btop               # Resource monitor
    htop

    ##########################################
    # Clipboard / Wayland Utilities
    ##########################################
    xclip
    wl-clipboard
    clipster

    ##########################################
    # Core UNIX Utilities
    ##########################################
    coreutils
    curl
    wget
    gnupg
    file
    rsync
    unzip
    zip
    procps
    psmisc
    util-linux
    tree
    stow

    ##########################################
    # Hardware / System Diagnostics
    ##########################################
    lshw
    pciutils
    usbutils
    lm_sensors

    ##########################################
    # Networking
    ##########################################
    iwd
    iproute2
    iputils
    traceroute
    dnsutils
    nmap

    ##########################################
    # Storage / Filesystems
    ##########################################
    e2fsprogs
    ntfs3g
    dosfstools

    ##########################################
    # Certificates / SSL
    ##########################################
    cacert

    ##########################################
    # GUI Applications
    ##########################################
    firefox
    chromium
    brave
    unstable.discord
    flameshot
    chirp
    unstable.anydesk
  ];
}

----
modules/users/borba.nix

{ pkgs, ... }:
{
  users.users.borba = {
    isNormalUser = true;
    description = "BORBA JR W";
    shell = pkgs.zsh;

    extraGroups = [
      "wheel"
      "networkmanager"
      "docker"
      "libvirtd"
      "dialout"
    ];
  };

  security.sudo.extraRules = [
    {
      users = [ "borba" ];
      commands = [
        {
          command = "/run/current-system/sw/bin/nixos-rebuild";
          options = [ "NOPASSWD" ];
        }
      ];
    }
  ];
}

----
modules/virtualization/libvirt.nix

{ ... }:
{
  virtualisation.libvirtd = {
    enable = true;

    qemu.swtpm.enable = true;

    allowedBridges = [
      "virbr0"
      "br0"
    ];
  };

  security.polkit.enable = true;
}

----
output.txt


----
profiles/dell.nix

{ ... }:

{
  ############################################
  # Host identity
  ############################################
  networking.hostName = "dell-nixos";

  ############################################
  # Bootloader (Legacy BIOS)
  ############################################
  boot.loader.grub = {
    enable = true;
    devices = [ "/dev/sda" ];
  };
}

----
profiles/macbook.nix

{ ... }:

{
  ############################################
  # Host identity
  ############################################
  networking.hostName = "macbook-nixos";

  ############################################
  # Bootloader (EFI)
  ############################################
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;
}

