----
configuration.nix

{ config, pkgs, ... }:

{
  imports = [

    ##########################################
    # Host profile (choose ONE)
    ##########################################
    ./profiles/dell.nix
    # ./profiles/macbook.nix

    ##########################################
    # Hardware
    ##########################################
    ./hardware-configuration-dell.nix
    ./modules/hardware/dell.nix

    ##########################################
    # Performance tuning (choose ONE)
    ##########################################
    ./modules/performance/common.nix
    ./modules/performance/dell.nix
    # ./modules/performance/macbook.nix

    ##########################################
    # Core system
    ##########################################
    ./modules/base.nix
    ./modules/networking.nix
    ./modules/audio.nix
    ./modules/fonts.nix

    ##########################################
    # Desktop
    ##########################################
    ./modules/desktops/gnome.nix
    ./modules/autologin.nix

    ##########################################
    # Containers / Virtualization
    ##########################################

    ./modules/containers/docker.nix
    # ./modules/containers/podman.nix
    ./modules/containers/docker.nix
    ./modules/containers/k3s.nix
    ./modules/virtualization/libvirt.nix

    ##########################################
    # Users / Packages / Nix
    ##########################################
    ./modules/users/borba.nix
    ./modules/system-packages.nix
    ./modules/nixpkgs.nix

  ];

  ############################################
  # System state version
  ############################################
  system.stateVersion = "25.11";
}

----
default.nix

# default.nix
#
# Required entrypoint for nixos-rebuild when using:
#   -I nixos-config=/path/to/repo
#
# Do not add logic here.

import ./configuration.nix

----
hardware-configuration-dell.nix

# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "ehci_pci" "ahci" "ums_realtek" "usb_storage" "sd_mod" "sr_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

#  fileSystems."/" =
#    { device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
#      fsType = "ext4";
#    };

  fileSystems."/" = {
    device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
    fsType = "ext4";
    options = [
      "noatime"
      "nodiratime"
      "commit=60"
    ];
  };    

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

----
hardware-configuration-macbook.nix

# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "ehci_pci" "ahci" "ums_realtek" "usb_storage" "sd_mod" "sr_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
      fsType = "ext4";
    };

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

----
modules/audio.nix

{ ... }:
{
  services.pulseaudio.enable = false;
  security.rtkit.enable = true;

  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
  };
}

----
modules/autologin.nix

{ ... }:

{
  services.displayManager.autoLogin = {
    enable = true;
    user = "borba";
  };

  # Prevent TTY race with graphical session
  systemd.services."getty@tty1".enable = false;
  systemd.services."autovt@tty1".enable = false;
}

----
modules/base.nix

{ pkgs, ... }:
{
  nix.extraOptions = ''
    experimental-features = nix-command flakes
  '';

  programs.zsh.enable = true;

  time.timeZone = "America/Sao_Paulo";

  i18n.defaultLocale = "en_US.UTF-8";
  i18n.extraLocaleSettings = {
    LC_ADDRESS = "pt_BR.UTF-8";
    LC_IDENTIFICATION = "pt_BR.UTF-8";
    LC_MEASUREMENT = "pt_BR.UTF-8";
    LC_MONETARY = "pt_BR.UTF-8";
    LC_NAME = "pt_BR.UTF-8";
    LC_NUMERIC = "pt_BR.UTF-8";
    LC_PAPER = "pt_BR.UTF-8";
    LC_TELEPHONE = "pt_BR.UTF-8";
    LC_TIME = "pt_BR.UTF-8";
  };

  console.keyMap = "br-abnt2";
}

----
modules/containers/common.nix


----
modules/containers/docker.nix

{ pkgs, lib, ... }:

{
  ############################################
  # Docker (ACTIVE)
  ############################################

  virtualisation.docker = {
    enable = true;
    enableOnBoot = true;
  };

  environment.systemPackages = with pkgs; [
    docker
    docker-compose
    docker-buildx
    lazydocker
  ];

  users.users.borba.extraGroups = [ "docker" ];

  ############################################
  # Explicitly disable Podman
  ############################################

  virtualisation.podman.enable = lib.mkForce false;
}

----
modules/containers/k3s.nix

{ config, pkgs, ... }:

{
  ############################################
  # K3s (single-node workstation cluster)
  ############################################
  services.k3s = {
    enable = true;
    role = "server";

    extraFlags = [
      "--write-kubeconfig-mode=644"
      "--disable=traefik"
      "--disable=servicelb"
    ];
  };

  ############################################
  # Firewall
  ############################################
  networking.firewall.allowedTCPPorts = [
    6443 # Kubernetes API
  ];
}

----
modules/containers/podman.nix

{ pkgs, lib, ... }:

{
  ############################################
  # Podman (ACTIVE - Rootless)
  ############################################

  virtualisation.podman = {
    enable = true;

    # Docker-compatible CLI & socket
    dockerCompat = true;
    dockerSocket.enable = true;

    defaultNetwork.settings = {
      dns_enabled = true;
    };
  };

  environment.systemPackages = with pkgs; [
    podman
    podman-compose
    buildah
    skopeo
    lazydocker # funciona com podman via docker socket
  ];

  ############################################
  # Rootless Podman requirements
  ############################################

  users.users.borba.linger = true;

  ############################################
  # Explicitly disable Docker
  ############################################

  virtualisation.docker.enable = lib.mkForce false;
}

----
modules/desktops/gnome.nix

{ pkgs, ... }:

{
  services.xserver.enable = true;

  services.displayManager.gdm = {
    enable = true;
    wayland = true;
  };

  services.desktopManager.gnome.enable = true;

  # Disable unnecessary GNOME services and animations
  services.gnome = {
    core-apps.enable = true;
    gnome-keyring.enable = true;
  };

  environment.sessionVariables = {
    # Wayland native
    XDG_SESSION_TYPE = "wayland";
    QT_QPA_PLATFORM = "wayland";
    MOZ_ENABLE_WAYLAND = "1";
    NIXOS_OZONE_WL = "1";

    # Reduce frame scheduling overhead
    # MUTTER_DEBUG_DISABLE_HW_CURSORS = "1";
  };

  # Portals (required for Wayland apps)
  xdg.portal = {
    enable = true;
    extraPortals = with pkgs; [
      xdg-desktop-portal-gnome
      xdg-desktop-portal-gtk
    ];
  };
}

----
modules/fonts.nix

{ pkgs, ... }:

{
  ############################################
  # Fonts
  ############################################
  fonts = {
    packages = with pkgs; [
      nerd-fonts.jetbrains-mono
    ];

    fontconfig = {
      enable = true;

      defaultFonts = {
        monospace = [ "JetBrainsMono Nerd Font" ];
      };
    };
  };
}

----
modules/hardware/dell.nix

{
  config,
  pkgs,
  lib,
  ...
}:

{
  networking.enableB43Firmware = true;

  # Dell ACPI modules break Wi-Fi/Bluetooth on older models
  boot.blacklistedKernelModules = [
    "dell_laptop"
  ];

  environment.systemPackages = with pkgs; [
    b43FirmwareCutter
    iw
  ];
}

----
modules/hardware/macbook.nix

{ pkgs, ... }:
{
  hardware.enableRedistributableFirmware = true;

  networking.enableB43Firmware = true;

  boot.blacklistedKernelModules = [
    "brcmsmac"
    "wl"
  ];

  environment.systemPackages = with pkgs; [
    b43-firmware-legacy
    b43-fwcutter
    wirelesstools
    rfkill
  ];

}

----
modules/networking.nix

{ ... }:
{
  networking.networkmanager.enable = true;

  systemd.services.NetworkManager-wait-online.enable = false;
}

----
modules/nixpkgs.nix

{ lib, ... }:
{
  nixpkgs = {
    config = {
      allowUnfree = true;
    };

    overlays = [
      (final: prev: {
        unstable = import <nixpkgs-unstable> {
          config.allowUnfree = true;
        };
      })
    ];
  };
}

----
modules/performance/common.nix

{ lib, pkgs, ... }:

{
  ############################################
  # Boot & system noise reduction
  ############################################

#  boot.kernelParams = [
#    "quiet"
#    "loglevel=3"
#    "rd.systemd.show_status=false"
#    "udev.log_level=3"
#  ];

  boot.consoleLogLevel = 0;


  ############################################
  # systemd startup optimizations
  ############################################

  systemd.services.systemd-udev-settle.enable = false;
  systemd.services.systemd-timesyncd.enable = true;

  systemd.extraConfig = ''
    DefaultTimeoutStartSec=10s
    DefaultTimeoutStopSec=10s
  '';


  ############################################
  # Memory & VM tuning (safe defaults)
  ############################################

  boot.kernel.sysctl = {
    "vm.swappiness" = lib.mkDefault 15;
    "vm.vfs_cache_pressure" = 50;
    "vm.dirty_background_ratio" = 5;
    "vm.dirty_ratio" = 15;
  };


  ############################################
  # Nix daemon performance
  ############################################

  nix.settings = {
    auto-optimise-store = true;
    warn-dirty = false;
    keep-outputs = true;
    keep-derivations = true;
  };


  ############################################
  # Journal & logging (reduce IO)
  ############################################

  services.journald.extraConfig = ''
    SystemMaxUse=200M
    RuntimeMaxUse=100M
    MaxRetentionSec=7day
    Compress=yes
  '';


  ############################################
  # Disable unnecessary background services
  ############################################

  services.udisks2.enable = lib.mkDefault true;
  services.fwupd.enable = lib.mkDefault false;
  services.printing.enable = lib.mkDefault false;


  ############################################
  # DNS (faster, less blocking)
  ############################################

  services.resolved = {
    enable = true;
    dnssec = "allow-downgrade";
    fallbackDns = [
      "1.1.1.1"
      "9.9.9.9"
    ];
  };


  ############################################
  # ZRAM (safe for low/mid RAM systems)
  ############################################

  zramSwap = {
    enable = true;
    algorithm = "zstd";
    memoryPercent = 25;
  };

}

----
modules/performance/dell.nix

{ lib, ... }:

{
  ############################################
  # Boot performance
  ############################################

  # Faster and more parallel initrd
  boot.initrd.systemd.enable = true;

  # Reduce boot verbosity and overhead
  boot.kernelParams = [
    "quiet"
    "loglevel=3"
  ];

  # Avoid unnecessary waits during boot
  # systemd.services.systemd-udev-settle.enable = false;


  ############################################
  # CPU scheduling & memory behavior
  ############################################

  # Best balance for older CPUs (desktop use)
  powerManagement.cpuFreqGovernor = "schedutil";

  # Reduce memory pressure and disk thrashing
#  boot.kernel.sysctl = {
#    "vm.swappiness" = 10;
#  };


  ############################################
  # Nix build performance (avoid system stalls)
  ############################################

  nix.settings = {
    max-jobs = 2;
    cores = 2;
  };


  ############################################
  # Container services (do NOT auto-start)
  ############################################

  # Keep Docker installed but do not start at boot
  virtualisation.docker.enableOnBoot = lib.mkForce false;

  # Keep K3s installed but do not auto-start
  systemd.services.k3s.wantedBy = lib.mkForce [];


  ############################################
  # Desktop / GNOME performance hints
  ############################################

  environment.sessionVariables = {
    # Reduce Mutter overhead on older Intel iGPU
    MUTTER_DEBUG_DISABLE_HW_CURSORS = "1";
    MUTTER_DEBUG_FORCE_KMS_MODE = "simple";
  };
}

----
modules/performance/macbook.nix

{ lib, ... }:

{
  ############################################
  # Boot (EFI)
  ############################################

  boot.kernelParams = [
    "quiet"
    "loglevel=3"
  ];


  ############################################
  # CPU (aggressive power saving)
  ############################################

  powerManagement.cpuFreqGovernor = "powersave";


  ############################################
  # Disk / IO (MacBooks suffer more here)
  ############################################

#  boot.kernel.sysctl = {
#    "vm.swappiness" = 20;
#  };


  ############################################
  # Containers disabled by default
  ############################################

  virtualisation.docker.enable = lib.mkForce false;
  systemd.services.k3s.wantedBy = lib.mkForce [];
}

----
modules/system-packages.nix

{ pkgs, ... }:

let
  unstable = pkgs.unstable or pkgs;
in
{
  environment.systemPackages = with pkgs; [

    ##########################################
    # Terminals
    ##########################################
    alacritty # GPU-accelerated terminal
    kitty # Feature-rich terminal
    gnome-console # GNOME default terminal

    ##########################################
    # Shells & Multiplexers
    ##########################################
    zsh # Primary shell
    fish # Alternative shell
    tmux # Terminal multiplexer
    tmuxifier # tmux session manager
    zellij # Modern tmux alternative

    ##########################################
    # Editors & Development UX
    ##########################################
    unstable.neovim # Neovim (unstable for faster updates)
    helix # Modal editor, LSP-first
    unstable.vscode
    unstable.vscode-extensions.ms-vscode-remote.remote-containers

    ##########################################
    # Git & Developer Workflow
    ##########################################
    git
    gh # GitHub CLI
    lazygit # TUI for git
    commitizen # Conventional commits helper
    devcontainer # Dev container tooling

    ##########################################
    # Notes / Knowledge Base
    ##########################################
    unstable.obsidian

    ##########################################
    # Containers / Virtualization / Kubernetes
    ##########################################
    docker
    docker-compose
    docker-buildx
    lazydocker
    podman
    podman-compose
    buildah
    skopeo
    cri-tools
    k9s

    virt-manager
    virt-viewer
    qemu
    virtio-win
    spice
    spice-gtk
    spice-protocol

    ##########################################
    # Languages / Toolchains
    ##########################################
    gcc
    libgcc
    glibc
    libcxx
    go
    gopls
    rustup
    rust-analyzer

    ##########################################
    # Build & Debug Tooling
    ##########################################
    cmake
    gnumake
    libtool
    libvterm
    unstable.gdb
    unstable.clang
    unstable.llvm
    unstable.lld

    ##########################################
    # Nix Tooling
    ##########################################
    nixd # Nix language server
    nil # Alternative Nix LSP
    statix # Static analysis for Nix
    deadnix # Find unused Nix code
    nixfmt-rfc-style # Nix formatter

    ##########################################
    # Modern CLI Utilities (Shell-first / DevOps)
    ##########################################
    eza # ls replacement
    bat # cat replacement
    fd # find replacement
    ripgrep # grep replacement
    yazi # Terminal file manager
    dust # du replacement
    ncdu # Disk usage analyzer
    zoxide # Smarter cd
    atuin # Shell history with sync
    tldr # Simplified man pages
    sd # sed replacement
    jq # JSON processor
    fx # Interactive JSON viewer
    httpie # Modern HTTP client
    curlie # curl + httpie hybrid
    fzf # Fuzzy finder
    direnv # Per-directory environments
    entr # Run commands on file changes
    procs # ps replacement
    bottom # Advanced system monitor
    btop # Resource monitor
    htop

    ##########################################
    # Clipboard / Wayland Utilities
    ##########################################
    xclip
    wl-clipboard
    clipster

    ##########################################
    # Core UNIX Utilities
    ##########################################
    coreutils
    curl
    wget
    gnupg
    file
    rsync
    unzip
    zip
    procps
    psmisc
    util-linux
    tree
    stow

    ##########################################
    # Hardware / System Diagnostics
    ##########################################
    lshw
    pciutils
    usbutils
    lm_sensors

    ##########################################
    # Networking
    ##########################################
    iwd
    iproute2
    iputils
    traceroute
    dnsutils
    nmap

    ##########################################
    # Storage / Filesystems
    ##########################################
    e2fsprogs
    ntfs3g
    dosfstools

    ##########################################
    # Certificates / SSL
    ##########################################
    cacert

    ##########################################
    # GUI Applications
    ##########################################
    firefox
    chromium
    brave
    unstable.discord
    flameshot
    chirp
    unstable.anydesk
  ];
}

----
modules/users/borba.nix

{ pkgs, ... }:
{
  users.users.borba = {
    isNormalUser = true;
    description = "BORBA JR W";
    shell = pkgs.zsh;

    extraGroups = [
      "wheel"
      "networkmanager"
      "docker"
      "libvirtd"
      "dialout"
    ];
  };

  ############################################
  # Security-impact-free kernel tweaks
  ############################################

  security.sudo.wheelNeedsPassword = false;

  security.sudo.extraRules = [
    {
      users = [ "borba" ];
      commands = [
        {
          command = "/run/current-system/sw/bin/nixos-rebuild";
          options = [ "NOPASSWD" ];
        }
      ];
    }
  ];
}

----
modules/virtualization/libvirt.nix

{ ... }:
{
  virtualisation.libvirtd = {
    enable = true;

    qemu.swtpm.enable = true;

    allowedBridges = [
      "virbr0"
      "br0"
    ];
  };

  security.polkit.enable = true;
}

----
output.txt


----
profiles/dell.nix

{ ... }:

{
  ############################################
  # Host identity
  ############################################
  networking.hostName = "dell-nixos";

  ############################################
  # Bootloader (Legacy BIOS)
  ############################################
  boot.loader.grub = {
    enable = true;
    devices = [ "/dev/sda" ];
  };
}

----
profiles/macbook.nix

{ ... }:

{
  ############################################
  # Host identity
  ############################################
  networking.hostName = "macbook-nixos";

  ############################################
  # Bootloader (EFI)
  ############################################
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;
}

