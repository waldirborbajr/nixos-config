----
.github/workflows/nixos.yaml

name: Nix Lint

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: nixfmt check
        run: |
          nix-shell -p nixfmt-rfc-style --run '
            find . -name "*.nix" \
              ! -name "hardware-configuration-*.nix" \
              -print0 | xargs -0 nixfmt --check
          '

      # statix intentionally disabled:
      # - generates noisy warnings on working configs
      # - risky to auto-fix without manual review
      # - will be re-enabled after config stabilization
      #
      # - name: statix
      #   run: nix-shell -p statix --run "statix check ."

      - name: deadnix
        run: |
          nix-shell -p deadnix --run '
            deadnix \
              --exclude hardware-configuration-dell.nix,hardware-configuration-macbook.nix \
              .
          '

      - name: Lint summary
        if: always()
        run: |
          {
            echo "## ðŸ§¹ Nix Lint"
            echo ""
            echo "- nixfmt: OK"
            echo "- deadnix: OK"
            echo ""
            echo "_Build and evaluation intentionally disabled._"
          } >> $GITHUB_STEP_SUMMARY

----
configuration.nix

# configuration.nix
{ config, pkgs, lib, ... }:

{
  ############################################
  # Host-specific configurations
  ############################################
  imports = [
    ./hosts/macbook.nix
    # ./hosts/dell.nix

    ############################################
    # Core system modules
    ############################################
    ./core.nix
  ];

  ############################################
  # NixOS version compatibility
  ############################################
  system.stateVersion = "25.11";
}

----
core.nix

# core.nix
{ ... }:

{
  imports = [

    ##########################################
    # Core system
    ##########################################
    ./modules/nixpkgs.nix    
    ./modules/base.nix
    ./modules/networking.nix
    ./modules/audio.nix
    ./modules/fonts.nix
    

    ##########################################
    # Desktop
    ##########################################
    ./modules/desktops/gnome.nix
    ./modules/autologin.nix

    ##########################################
    # Containers / Virtualization
    ##########################################
    ./modules/containers/docker.nix
    ./modules/containers/k3s.nix
    ./modules/virtualization/libvirt.nix

    ##########################################
    # Users / Dev
    ##########################################
    ./modules/users/borba.nix
    ./modules/system-packages.nix
    ./modules/python/default.nix
    ./modules/nodejs/default.nix

    ##########################################
    # Flatpak
    ##########################################
    ./modules/flatpak/enable.nix
    ./modules/flatpak/packages.nix

    ##########################################
    # Access
    ##########################################
    ./modules/ssh.nix
  ];
}

----
default.nix

# default.nix
#
# Required entrypoint for nixos-rebuild when using:
#   -I nixos-config=/path/to/repo
#
# Do not add logic here.

import ./configuration.nix

----
flake.nix

# flake.nix
# ---
{
  description = "Multi-host NixOS flake for Borba";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.11";
  };

  outputs = { self, nixpkgs, ... }: {

    nixosConfigurations = {

      # ==========================================
      # MacBook host
      # ==========================================
      macbook = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        modules = [
          ./core.nix
          ./hosts/macbook.nix
        ];
      };

      # ==========================================
      # Dell host
      # ==========================================
      dell = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        modules = [
          ./core.nix
          ./hosts/dell.nix
        ];
      };

    };
  };
}

----
hardware-configuration-dell.nix

# hardware-configuration-dell.nix
# ---
# Do not modify this file!  It was generated by â€˜nixos-generate-configâ€™
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "ehci_pci" "ahci" "ums_realtek" "usb_storage" "sd_mod" "sr_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

#  fileSystems."/" =
#    { device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
#      fsType = "ext4";
#    };

  fileSystems."/" = {
    device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
    fsType = "ext4";
    options = [
      "noatime"
      "nodiratime"
      "commit=60"
    ];
  };    

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

----
hardware-configuration-macbook.nix

# hardware-configuration-macbook.nix
# ---
# Do not modify this file!  It was generated by â€˜nixos-generate-configâ€™
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "uhci_hcd" "ehci_pci" "ahci" "firewire_ohci" "usbhid" "usb_storage" "sd_mod" "sr_mod" "sdhci_pci" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/603dddd0-c90c-423c-add7-8691178dd12e";
      fsType = "ext4";
    };

  fileSystems."/boot" =
    { device = "/dev/disk/by-uuid/75E6-696A";
      fsType = "vfat";
      options = [ "fmask=0077" "dmask=0077" ];
    };

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}
----
hosts/dell.nix

# hosts/dell.nix
# ---
#     nixos-config/hosts/dell.nix

{ config, pkgs, lib, ... }:
{
  ############################################
  # Hardware
  ############################################
  imports = [
    ../modules/hardware/dell.nix
    ../modules/performance/dell.nix
    ../hardware-configuration-dell.nix
  ];
  ############################################
  # Host identity
  ############################################
  networking.hostName = "dell-nixos";
  ############################################
  # Bootloader (Legacy BIOS)
  ############################################
  boot.loader.grub.enable = true;
  boot.loader.grub.devices = [ "/dev/sda" ];
  ############################################
  # Keyboard (Dell)
  ############################################
  console.keyMap = "br-abnt2";
  services.xserver.xkb = {
    layout = "br";
    variant = "abnt2";
  };
}

----
hosts/macbook.nix

# hosts/macbook.nix
# ---
# ==========================================
# hosts/macbook.nix
# ==========================================

{ config, pkgs, lib, ... }:

{
  ############################################
  # Hardware & Performance
  ############################################
  imports = [
    ../modules/nixpkgs.nix              # MÃ³dulo Nixpkgs primeiro para allowUnfree
    ../modules/hardware/macbook.nix
    ../modules/performance/macbook.nix
    ../hardware-configuration-macbook.nix
  ];

  ############################################
  # Host identity
  ############################################
  networking.hostName = "macbook-nixos";

  ############################################
  # Bootloader (EFI)
  ############################################
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  ############################################
  # Keyboard layout
  ############################################
  console.keyMap = "us";

  ############################################
  # X11 layout
  ############################################
  services.xserver.enable = true;
  services.xserver.xkb = {
    layout = "us";
    variant = "";
  };

  ############################################
  # Permitir pacote Broadcom STA inseguro
  ############################################
  nixpkgs.config.permittedInsecurePackages = [
    "broadcom-sta-6.30.223.271-59-6.12.66"
  ];

  ############################################
  # Pacotes extras para Wi-Fi e debug
  ############################################
  environment.systemPackages = with pkgs; [
    iw
    wirelesstools
    util-linux              # garante rfkill
    linuxPackages.broadcom_sta
  ];
}

----
modules/audio.nix

# modules/audio.nix
# ---
{ ... }:
{
  services.pulseaudio.enable = false;
  security.rtkit.enable = true;

  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
  };
}

----
modules/autologin.nix

# modules/autologin.nix
# ---
{ ... }:

{
  services.displayManager.autoLogin = {
    enable = true;
    user = "borba";
  };

  # Prevent TTY race with graphical session
  systemd.services."getty@tty1".enable = false;
  systemd.services."autovt@tty1".enable = false;
}

----
modules/base.nix

# modules/base.nix
# ---
{ pkgs, ... }:
{
  nix.extraOptions = ''
    experimental-features = nix-command flakes
  '';

  programs.zsh.enable = true;

  time.timeZone = "America/Sao_Paulo";

  i18n.defaultLocale = "en_US.UTF-8";
  i18n.extraLocaleSettings = {
    LC_ADDRESS = "pt_BR.UTF-8";
    LC_IDENTIFICATION = "pt_BR.UTF-8";
    LC_MEASUREMENT = "pt_BR.UTF-8";
    LC_MONETARY = "pt_BR.UTF-8";
    LC_NAME = "pt_BR.UTF-8";
    LC_NUMERIC = "pt_BR.UTF-8";
    LC_PAPER = "pt_BR.UTF-8";
    LC_TELEPHONE = "pt_BR.UTF-8";
    LC_TIME = "pt_BR.UTF-8";
  };

  # console.keyMap = "br-abnt2";

  ############################################
  # Infra aliases (NixOS lifecycle)
  ############################################
  environment.shellAliases = {
    nixgc   = "sudo nix-collect-garbage";
    garbage = "sudo nix-collect-garbage -d --delete-older-than 1d";

    build   = "sudo nixos-rebuild build -I nixos-config=$HOME/nixos-config";
    switch  = "make switch";
    upgrade = "sudo nixos-rebuild switch --upgrade -I nixos-config=$HOME/nixos-config";

    rebuild-safe = "sudo systemctl isolate multi-user.target \
      && sudo nixos-rebuild switch -I nixos-config=$HOME/nixos-config \
      && sudo systemctl isolate graphical.target";
  };

  ############################################
  # Avoid user unit reload stalls
  ############################################
  systemd.user.extraConfig = ''
    DefaultTimeoutStartSec=30s
    DefaultTimeoutStopSec=30s
  '';
}

----
modules/containers/common.nix

# modules/containers/common.nix
{ config, lib, pkgs, ... }:

{
  # Intentionally left empty.
  #
  # This module is reserved for future container policies
  # shared across all runtimes (Docker, Podman, etc).
}

----
modules/containers/docker.nix

# modules/containers/docker.nix
# ---
{ config, pkgs, lib, ... }:

{
  virtualisation.docker = {
    enable = true;
    enableOnBoot = true;
    daemon.settings = {
      features = {
        buildkit = true;
      };
    };
  };

  environment.systemPackages = with pkgs; [
    docker
    docker-compose
    docker-buildx
    lazydocker
  ];

  users.users.borba.extraGroups = lib.mkAfter [ "docker" ];
}

----
modules/containers/k3s.nix

# modules/containers/k3s.nix
# ---
{ config, pkgs, ... }:

{
  ############################################
  # K3s (single-node workstation cluster)
  ############################################
  services.k3s = {
    enable = true;
    role = "server";

    extraFlags = [
      "--write-kubeconfig-mode=644"
      "--disable=traefik"
      "--disable=servicelb"
    ];
  };

  ############################################
  # Firewall
  ############################################
  networking.firewall.allowedTCPPorts = [
    6443 # Kubernetes API
  ];
}

----
modules/containers/podman.nix

# modules/containers/podman.nix
# ---
{ config, pkgs, lib, ... }:

{
  virtualisation.podman = {
    enable = true;
    dockerCompat = true;
    defaultNetwork.settings.dns_enabled = true;
  };

  environment.systemPackages = with pkgs; [
    podman
    podman-compose
    buildah
    skopeo
  ];

  # Podman rootless correto
  services.userManagement.enable = true;

  users.users.borba = {
    linger = true;
  };
}

----
modules/desktops/gnome.nix

# modules/desktops/gnome.nix
# ---
{ pkgs, ... }:

{
  services.xserver.enable = true;

  services.displayManager.gdm = {
    enable = true;
    wayland = true;
  };

  services.desktopManager.gnome.enable = true;

  # Disable unnecessary GNOME services and animations
  services.gnome = {
    core-apps.enable = true;
    gnome-keyring.enable = true;
  };

  environment.sessionVariables = {
    # Wayland native
    XDG_SESSION_TYPE = "wayland";
    QT_QPA_PLATFORM = "wayland";
    MOZ_ENABLE_WAYLAND = "1";
    NIXOS_OZONE_WL = "1";

    # Reduce frame scheduling overhead
    # MUTTER_DEBUG_DISABLE_HW_CURSORS = "1";
  };

  # Portals (required for Wayland apps)
  xdg.portal = {
    enable = true;
    extraPortals = with pkgs; [
      xdg-desktop-portal-gnome
      xdg-desktop-portal-gtk
    ];
  };
}

----
modules/flatpak/enable.nix

# modules/flatpak/enable.nix
# ---
{ config, pkgs, ... }:

{
  ##########################################
  # Flatpak
  ##########################################

  services.flatpak.enable = true;

  ##########################################
  # XDG Portal (needed for Flatpak apps)
  ##########################################

  xdg.portal.enable = true;

  xdg.portal.extraPortals = with pkgs; [
    xdg-desktop-portal-gtk
  ];
}

----
modules/flatpak/packages.nix

# modules/flatpak/packages.nix
{ config, pkgs, ... }:

let
  desired = [
    # Browsers
    "org.mozilla.firefox"
    "com.brave.Browser"

    # Development / IDE
    "com.visualstudio.code"

    # Communication
    "com.discordapp.Discord"
    "me.proton.Mail"

    # Knowledge / Media
    "md.obsidian.Obsidian"

    # Utilities
    "com.anydesk.Anydesk"

    # Media / Graphics
    "org.gimp.GIMP"
    "org.inkscape.Inkscape"
    "org.audacityteam.Audacity"
    "fr.handbrake.ghb"
    "io.mpv.Mpv"
    "org.imagemagick.ImageMagick"

    # Downloads / Torrents
    "com.transmissionbt.Transmission"

    # Screen Shot
    "be.alexandervanhee.gradia"
    "org.flameshot.Flameshot"
#    "org.mozilla.firefoxdeveloperedition"
#    "org.chromium.Chromium"
#    "com.vivaldi.Vivaldi"
#    "com.google.AndroidStudio"
#    "com.obsproject.Studio"
#    "com.ticktick.TickTick"
#    "com.calibre_ebook.calibre"
#    "org.libreoffice.LibreOffice"
  ];
in
{
  system.userActivationScripts.flatpakInstall = {
    text = ''
      # Ensure Flathub remote (redundant but safe)
      ${pkgs.flatpak}/bin/flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

      installed=$(${pkgs.flatpak}/bin/flatpak list --app --columns=application)

      for app in ${builtins.toString desired}; do
        if ! echo "$installed" | grep -q -F "$app"; then
          echo "Installing missing Flatpak: $app"
          ${pkgs.flatpak}/bin/flatpak install -y --noninteractive flathub "$app" || true
        fi
      done

      # Optional: update all
      echo "Updating Flatpaks..."
      ${pkgs.flatpak}/bin/flatpak update -y --noninteractive || true

      # Clean up unused runtimes
      ${pkgs.flatpak}/bin/flatpak uninstall --unused -y || true

      # Uncomment below if you want strict mode (remove apps not in list)
      # for app in $installed; do
      #   if ! echo "${builtins.toString desired}" | grep -q -F "$app"; then
      #     echo "Removing unmanaged: $app"
      #     ${pkgs.flatpak}/bin/flatpak uninstall -y --noninteractive "$app" || true
      #   fi
      # done
    '';
  };
}

----
modules/fonts.nix

# modules/fonts.nix
# ---
{ pkgs, ... }:
{
  ############################################
  # Fonts
  ############################################
  fonts = {
    packages = with pkgs; [
      nerd-fonts.jetbrains-mono
    ];
    fontconfig = {
      enable = true;
      defaultFonts = {
        monospace = [ "JetBrainsMono Nerd Font" ];
      };
    };
  };
}

----
modules/hardware/dell.nix

# modules/hardware/dell.nix
# ---
{
  config,
  pkgs,
  lib,
  ...
}:

{
  networking.enableB43Firmware = true;

  # Dell ACPI modules break Wi-Fi/Bluetooth on older models
  boot.blacklistedKernelModules = [
    "dell_laptop"
  ];

  environment.systemPackages = with pkgs; [
    b43FirmwareCutter
    iw
  ];
}

----
modules/hardware/macbook.nix

# modules/hardware/macbook.nix
{ config, pkgs, ... }:

{
  ############################################
  # Broadcom / Wireless
  ############################################
  hardware.enableRedistributableFirmware = true;

  # Blacklist drivers que conflitam com Broadcom proprietÃ¡rio
  boot.blacklistedKernelModules = [
    "b43"
    "brcmsmac"
    "bcma"
    "ssb"
  ];

  # Driver proprietÃ¡rio Broadcom
  boot.kernelModules = [ "wl" ];

  # Pacote do driver para o kernel ativo
  boot.extraModulePackages = with config.boot.kernelPackages; [
    broadcom_sta
  ];

  ############################################
  # Pacotes Ãºteis para debug e configuraÃ§Ã£o wireless
  ############################################
  environment.systemPackages = with pkgs; [
    iw
    wirelesstools
  ];
}

----
modules/networking.nix

# modules/networking.nix
# ---
{ ... }:
{
  networking.networkmanager.enable = true;

  systemd.services.NetworkManager-wait-online.enable = false;
}

----
modules/nixpkgs.nix

# modules/nixpkgs.nix
{ lib, pkgs, ... }:

let
  unstablePkgs = import (builtins.fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/nixos-unstable.tar.gz";
  }) {
    config = { allowUnfree = true; };
  };
in
{
  nixpkgs = {
    config.allowUnfree = true;

    overlays = [
      (final: prev: {
        unstable = unstablePkgs;
      })
    ];
  };
}

----
modules/nodejs/common.nix

# modules/nodejs/common.nix
# ---
{ pkgs, ... }:

{
  ############################################
  # NodeJS base (safe)
  ############################################

  environment.variables = {
    NPM_CONFIG_UPDATE_NOTIFIER = "false";
    NPM_CONFIG_FUND = "false";
    NPM_CONFIG_AUDIT = "false";
  };
}

----
modules/nodejs/default.nix

# modules/nodejs/default.nix
# ---
{ lib, ... }:

let
  enableNode = false; # true | false
in
{
  imports =
    lib.optionals enableNode [
      ./enable.nix
    ];
}

----
modules/nodejs/enable.nix

# modules/nodejs/enable.nix
# ---
{ pkgs, ... }:

{
  imports = [
    ./common.nix
  ];

  ############################################
  # NodeJS (enabled)
  ############################################

  environment.systemPackages = with pkgs; [
    nodejs_20   # LTS
    nodePackages.pnpm
  ];

  environment.shellAliases = {
    ni = "pnpm install";
    nr = "pnpm run";
    nx = "pnpm dlx nx";
  };
}

----
modules/performance/common.nix

# modules/performance/common.nix
# ---
{ lib, pkgs, ... }:

{
  ############################################
  # Boot & system noise reduction
  ############################################

  boot.consoleLogLevel = 0;

  ############################################
  # systemd startup optimizations
  ############################################
  
  systemd.services.systemd-udev-settle.enable = false;
  systemd.services.systemd-timesyncd.enable = true;
  
  systemd.settings.Manager = {
    DefaultTimeoutStartSec = "10s";
    DefaultTimeoutStopSec  = "10s";
  };

  ############################################
  # Memory & VM tuning (safe defaults)
  ############################################

  boot.kernel.sysctl = {
    "vm.swappiness" = lib.mkDefault 15;
    "vm.vfs_cache_pressure" = 50;
    "vm.dirty_background_ratio" = 5;
    "vm.dirty_ratio" = 15;
  };

  ############################################
  # Nix daemon performance
  ############################################

  nix.settings = {
    auto-optimise-store = true;
    warn-dirty = false;
    keep-outputs = true;
    keep-derivations = true;
  };

  ############################################
  # Journal & logging (reduce IO)
  ############################################

  services.journald.extraConfig = ''
    SystemMaxUse=200M
    RuntimeMaxUse=100M
    MaxRetentionSec=7day
    Compress=yes
  '';

  ############################################
  # Disable unnecessary background services
  ############################################

  services.udisks2.enable = lib.mkDefault true;
  services.fwupd.enable  = lib.mkDefault false;
  services.printing.enable = lib.mkDefault false;

  ############################################
  # DNS (faster, less blocking)
  ############################################

  services.resolved = {
    enable = true;
    dnssec = "allow-downgrade";
    fallbackDns = [
      "1.1.1.1"
      "9.9.9.9"
    ];
  };

  ############################################
  # ZRAM (safe for low/mid RAM systems)
  ############################################

  zramSwap = {
    enable = true;
    algorithm = "zstd";
    memoryPercent = 25;
  };

}

----
modules/performance/dell.nix

# modules/performance/dell.nix
# ---
{ lib, ... }:

{
  ############################################
  # Boot performance
  ############################################

  # Faster and more parallel initrd
  boot.initrd.systemd.enable = true;

  # Reduce boot verbosity and overhead
  boot.kernelParams = [
    "quiet"
    "loglevel=3"
  ];

  # Avoid unnecessary waits during boot
  # systemd.services.systemd-udev-settle.enable = false;


  ############################################
  # CPU scheduling & memory behavior
  ############################################

  # Best balance for older CPUs (desktop use)
  powerManagement.cpuFreqGovernor = "schedutil";

  # Reduce memory pressure and disk thrashing
#  boot.kernel.sysctl = {
#    "vm.swappiness" = 10;
#  };


  ############################################
  # Nix build performance (avoid system stalls)
  ############################################

  nix.settings = {
    max-jobs = 2;
    cores = 2;
  };


  ############################################
  # Container services (do NOT auto-start)
  ############################################

  # Keep Docker installed but do not start at boot
  virtualisation.docker.enableOnBoot = lib.mkForce false;

  # Keep K3s installed but do not auto-start
  systemd.services.k3s.wantedBy = lib.mkForce [];


  ############################################
  # Desktop / GNOME performance hints
  ############################################

  environment.sessionVariables = {
    # Reduce Mutter overhead on older Intel iGPU
    MUTTER_DEBUG_DISABLE_HW_CURSORS = "1";
    MUTTER_DEBUG_FORCE_KMS_MODE = "simple";
  };
}

----
modules/performance/macbook.nix

# modules/performance/macbook.nix
# ---
{ lib, ... }:

{
  ############################################
  # Boot (EFI)
  ############################################

  boot.kernelParams = [
    "quiet"
    "loglevel=3"
  ];


  ############################################
  # CPU (aggressive power saving)
  ############################################

  powerManagement.cpuFreqGovernor = "powersave";


  ############################################
  # Disk / IO (MacBooks suffer more here)
  ############################################

#  boot.kernel.sysctl = {
#    "vm.swappiness" = 20;
#  };


  ############################################
  # Containers disabled by default
  ############################################

  virtualisation.docker.enable = lib.mkForce false;
  systemd.services.k3s.wantedBy = lib.mkForce [];
}

----
modules/python/common.nix

# modules/python/common.nix
# ---
{ pkgs, ... }:

{
  ############################################
  # Python base (safe, shared)
  ############################################

  environment.systemPackages = with pkgs; [
    python3
    python3Packages.pip
    python3Packages.virtualenv
  ];

  environment.variables = {
    PIP_DISABLE_PIP_VERSION_CHECK = "1";
    PYTHONDONTWRITEBYTECODE = "1";
  };
}

----
modules/python/default.nix

# modules/python/default.nix
# ---
{ config, lib, ... }:

let
  pythonEnv = "uv"; # uv | poetry
in
{
  imports =
    lib.optionals (pythonEnv == "uv") [
      ./uv.nix
    ]
    ++ lib.optionals (pythonEnv == "poetry") [
      ./poetry.nix
    ];
}

----
modules/python/poetry.nix

# modules/python/poetry.nix
# ---
{ pkgs, ... }:

{
  imports = [
    ./common.nix
  ];

  ############################################
  # Python env manager: poetry (alternative)
  ############################################

  environment.systemPackages = with pkgs; [
    poetry
  ];

  environment.variables = {
    POETRY_VIRTUALENVS_IN_PROJECT = "true";
  };

  environment.shellAliases = {
    py = "poetry run python";
  };
}

----
modules/python/uv.nix

# modules/python/uv.nix
# ---
{ pkgs, ... }:

{
  imports = [
    ./common.nix
  ];

  ############################################
  # Python env manager: uv (preferred)
  ############################################

  environment.systemPackages = with pkgs; [
    uv
  ];

  environment.shellAliases = {
    venv = "uv venv";
    py   = "uv run python";
    pip  = "uv pip";
  };
}

----
modules/ssh.nix

# modules/ssh.nix
# ---
## Relation truth

#{ ... }:
#
#{
#  services.openssh = {
#    enable = true;
#    openFirewall = true;
#
#    settings = {
#      PermitRootLogin = "no";
#      PasswordAuthentication = false;
#      KbdInteractiveAuthentication = false;
#    };
#  };
#}


## Aak for user and password

{ ... }:

{
  services.openssh = {
    enable = true;

    settings = {
      PasswordAuthentication = true;
      KbdInteractiveAuthentication = true;
      PermitRootLogin = "no";
    };
  };
}

----
modules/system-packages.nix

# modules/system-packages.nix
# ---
{ pkgs, ... }:

let
  unstable = pkgs.unstable or pkgs;
in
{
  environment.systemPackages = with pkgs; [

    ##########################################
    # Terminals
    ##########################################
    alacritty # GPU-accelerated terminal
    kitty # Feature-rich terminal
    gnome-console # GNOME default terminal

    ##########################################
    # Shells & Multiplexers
    ##########################################
    zsh # Primary shell
    fish # Alternative shell
    tmux # Terminal multiplexer
    tmuxifier # tmux session manager
    zellij # Modern tmux alternative

    ##########################################
    # Editors & Development UX
    ##########################################
    # unstable.neovim # Neovim (unstable for faster updates)
    helix # Modal editor, LSP-first
    # unstable.vscode
    # unstable.vscode-extensions.ms-vscode-remote.remote-containers

    ##########################################
    # Git & Developer Workflow
    ##########################################
    git
    gh # GitHub CLI
    lazygit # TUI for git
    commitizen # Conventional commits helper
    devcontainer # Dev container tooling

    ##########################################
    # Notes / Knowledge Base
    ##########################################
    # unstable.obsidian

    ##########################################
    # Virtualization / Kubernetes (non-container runtime)
    ##########################################
    k9s
    cri-tools

    virt-manager
    virt-viewer
    qemu
    virtio-win
    spice
    spice-gtk
    spice-protocol

    ##########################################
    # Languages / Toolchains
    ##########################################
    gcc
    libgcc
    glibc
    libcxx
    go
    gopls
    rustup
    rust-analyzer
    lua
    lua-language-server

    ##########################################
    # Build & Debug Tooling
    ##########################################
    cmake
    gnumake
    libtool
    libvterm
    unstable.gdb
    unstable.clang
    unstable.llvm
    unstable.lld

    ##########################################
    # Nix Tooling
    ##########################################
    nixd # Nix language server
    nil # Alternative Nix LSP
    statix # Static analysis for Nix
    deadnix # Find unused Nix code
    nixfmt-rfc-style # Nix formatter

    ##########################################
    # Modern CLI Utilities (Shell-first / DevOps)
    ##########################################
    eza # ls replacement
    bat # cat replacement
    fd # find replacement
    ripgrep # grep replacement
    yazi # Terminal file manager
    dust # du replacement
    ncdu # Disk usage analyzer
    zoxide # Smarter cd
    atuin # Shell history with sync
    tldr # Simplified man pages
    sd # sed replacement
    jq # JSON processor
    fx # Interactive JSON viewer
    httpie # Modern HTTP client
    curlie # curl + httpie hybrid
    fzf # Fuzzy finder
    direnv # Per-directory environments
    entr # Run commands on file changes
    procs # ps replacement
    bottom # Advanced system monitor
    btop # Resource monitor
    htop

    ##########################################
    # Clipboard / Wayland Utilities
    ##########################################
    xclip
    wl-clipboard
    clipster

    ##########################################
    # Core UNIX Utilities
    ##########################################
    coreutils
    curl
    wget
    gnupg
    file
    rsync
    unzip
    zip
    procps
    psmisc
    util-linux
    tree
    stow

    ##########################################
    # Hardware / System Diagnostics
    ##########################################
    lshw
    pciutils
    usbutils
    lm_sensors

    ##########################################
    # Networking
    ##########################################
    iwd
    iproute2
    iputils
    traceroute
    dnsutils
    nmap

    ##########################################
    # Storage / Filesystems
    ##########################################
    e2fsprogs
    ntfs3g
    dosfstools

    ##########################################
    # Certificates / SSL
    ##########################################
    cacert

    ##########################################
    # GUI Applications
    ##########################################
    # firefox
    # chromium
    # brave
    # unstable.discord
    flameshot
    chirp
    # unstable.anydesk
  ];
}
# 
----
modules/users/borba.nix

# modules/users/borba.nix
# ---
{ pkgs, ... }:
{
  users.users.borba = {
    isNormalUser = true;
    description = "BORBA JR W";
    shell = pkgs.zsh;

    extraGroups = [
      "wheel"
      "networkmanager"
      "docker"
      "libvirtd"
      "dialout"
    ];

    ## Relation Truth

    #openssh.authorizedKeys.keys = [
    #  "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... borba@laptop"
    #];
  };

  ############################################
  # Security-impact-free kernel tweaks
  ############################################

  security.sudo.wheelNeedsPassword = false;

  security.sudo.extraRules = [
    {
      users = [ "borba" ];
      commands = [
        {
          command = "/run/current-system/sw/bin/nixos-rebuild";
          options = [ "NOPASSWD" ];
        }
      ];
    }
  ];
}

----
modules/virtualization/libvirt.nix

# modules/virtualization/libvirt.nix
# ---
{ ... }:
{
  virtualisation.libvirtd = {
    enable = true;

    qemu.swtpm.enable = true;

    allowedBridges = [
      "virbr0"
      "br0"
    ];
  };

  security.polkit.enable = true;
}

----
output.txt


----
profiles/dell.nix

# profiles/dell.nix
# ---
{ ... }:

{
  ############################################
  # Host identity
  ############################################
  networking.hostName = "dell-nixos";

  ############################################
  # Bootloader (Legacy BIOS)
  ############################################
  boot.loader.grub = {
    enable = true;
    devices = [ "/dev/sda" ];
  };

  ############################################
  # Keyboard (Dell)
  ############################################
  console.keyMap = "br-abnt2";

  services.xserver.xkb = {
    layout = "br";
    variant = "abnt2";
  };
}

----
profiles/macbook.nix

# profiles/macbook.nix
# ---
{ ... }:

{
  ############################################
  # Host identity
  ############################################
  networking.hostName = "macbook-nixos";

  ############################################
  # Bootloader (EFI)
  ############################################
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  ############################################
  # Keyboard (MacBook)
  ############################################
  console.keyMap = "us";

  services.xserver.xkb = {
    layout = "us";
    variant = "";
  };
}

