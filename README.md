# BORBA JR W - NixOS Configuration â„ï¸

Personal **NixOS workstation configuration**, focused on **simplicity, fast reinstallation, reproducibility and low maintenance**.

This repository is intentionally **not using Home Manager** for configuration management.  
Dotfiles and user-level configs are managed externally via **GNU Stow**, keeping this repo focused on **system-level reproducibility only**.

> Philosophy: *If I reinstall the OS, I want everything I need installed and working â€” nothing more, nothing less.*

---

## âœ¨ Goals

- âš¡ Fast boot and responsive desktop
- ğŸ” Simple and reliable reinstallation
- ğŸ§¹ Automatic cleanup and disk space reduction
- ğŸ§± Clear separation of **system**, **hardware**, **desktop**, and **user**
- ğŸ–¥ï¸ Optimized for **Dell Inspiron** laptops
- ğŸš« No Home Manager dependency
- ğŸ“¦ Deterministic package set (CLI, dev, desktop)

---

## Mapa mental atual

```
user-borba.nix        â†’ comportamento de login
desktop-gnome.nix    â†’ GNOME puro
system-programs.nix  â†’ serviÃ§os do sistema
kernel-tuning.nix    â†’ infra / journald / boot
hardware-*.nix       â†’ drivers e firmware
```
---

## ğŸ“ Repository Structure

```
.
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ build.sh
â”œâ”€â”€ init.sh
â”œâ”€â”€ configuration.nix
â”œâ”€â”€ hardware-configuration.nix
â”œâ”€â”€ modules/
â”‚     â”œâ”€â”€ containers/
â”‚     â”œâ”€â”€ docker.nix      # Docker + docker-compose + lazydocker
â”‚     â”œâ”€â”€ k3s.nix         # Single-node Kubernetes (K3s)
â”‚     â””â”€â”€ podman.nix      # Podman rootless + buildah + skopeo
â”œâ”€â”€ desktop-cinnamon.nix
â”œâ”€â”€ desktop-cosmic.nix
â”œâ”€â”€ desktop-gnome.nix
â”œâ”€â”€ desktop-hyprland.nix
â”œâ”€â”€ desktop-lxqt.nix
â”œâ”€â”€ fonts.nix
â”œâ”€â”€ hardware-dell.nix
â”œâ”€â”€ hardware-macbook-efi.nix
â”œâ”€â”€ hardware-macbook.nix
â”œâ”€â”€ hardware-radio-chirp.nix
â”œâ”€â”€ kernel-tuning.nix
â”œâ”€â”€ maintenance-hm.nix
â”œâ”€â”€ maintenance.nix
â”œâ”€â”€ nix-unstable.nix
â”œâ”€â”€ packages.nix
â”œâ”€â”€ system-packages.nix
â”œâ”€â”€ system-programs.nix
â”œâ”€â”€ user-borba.nix
â”œâ”€â”€ virt-wayland-tuning.nix
â””â”€â”€ virtualisation-bridge.nix
â””â”€â”€ prj
```

---

## ğŸ§© Module Responsibilities

### ğŸ”§ `configuration.nix`
Main entry point. Only **wires modules together** and defines host-level concerns:
- Hostname
- SSH
- Nix settings
- Imports modules
- Optional hardware & desktop profiles

---

### ğŸ–¥ï¸ Hardware

#### `hardware-configuration.nix`
Generated by NixOS. **Do not edit manually**.

#### `modules/hardware-dell.nix`
Dell Inspironâ€“specific hardware:
- Wi-Fi
- Bluetooth
- Audio
- Firmware / microcode
- Power optimizations

#### `modules/hardware-macbook.nix` / `hardware-macbook-efi.nix`
MacBook-specific hardware and EFI boot tuning.

---

### âš¡ Kernel & Boot

#### `modules/kernel-tuning.nix`
Performance-focused tuning:
- Faster boot
- Reduced initrd overhead
- Laptop-friendly scheduler & VM tuning

---

### ğŸ¨ Desktop

#### `modules/desktop-gnome.nix`
Default desktop:
- GNOME on Wayland
- GDM auto-login
- Reduced animations
- Fast startup

#### `modules/desktop-cosmic.nix`
Optional COSMIC Desktop profile, isolated and swappable.

#### `modules/desktop-cinnamon.nix`
Optional Cinnamon profile (lightweight, classic desktop). Uses LightDM.

> Only one desktop module should be imported at a time.

---

### ğŸ”¤ Fonts

#### `modules/fonts.nix`
System-wide fonts:
- JetBrainsMono Nerd Font (primary)
- Emoji + fallback fonts
- Fontconfig defaults

---

### ğŸ“¦ Packages & Programs

#### `modules/system-programs.nix`
Enable system programs declaratively:
- `zsh`, `firefox`, `zoxide`, etc.

#### `modules/system-packages.nix`
**Global system packages**:
- Terminals: `alacritty`, `kitty`
- Shell & multiplexers: `zsh`, `tmux`, `tmuxifier`
- Editors: `neovim`, `lazygit`
- Containers: `docker`, `podman`, `lazypodman`
- Kubernetes TUI: `k9s`
- Languages & Toolchains: `go`, `rust`, `gcc`, `clang`, `cmake`
- CLI tools: `eza`, `bat`, `btop`, `fd`, `ripgrep`, `yazi`
- Browsers: `brave`, `chromium`, `firefox-developer`
- Utilities: `flameshot`, `xclip`, `discord`, `microfetch`

Everything here is **machine-wide and reproducible**.

---

### ğŸ‘¤ User

#### `modules/user-borba.nix`
User-specific settings:
- User `borba`
- ZSH shell
- Docker / Podman / wheel / network groups
- **Passwordless sudo**
- **Automatic login**
- Dotfiles managed externally via **GNU Stow**

---

### ğŸ§¹ Maintenance & Cleanup

#### `modules/maintenance.nix`
Aggressive but safe cleanup:
- Daily GC (`--delete-older-than 2d`)
- Store deduplication
- Disk pressure auto-GC
- Limited system generations

#### `modules/maintenance-hm.nix`
Defensive cleanup of old Home Manager profiles.

---

### ğŸ³ Containers / Kubernetes

#### Module Responsibilities

All container tools are managed as system-wide packages and optional services.

Docker (modules/containers/docker.nix)

- System service enabled by default.

- Includes docker-compose and lazydocker.

- Fully integrated with the user borba.

- Podman (modules/containers/podman.nix)

- Rootless container runtime.

- Docker-compatible socket for switching between Docker and Podman.

- Includes podman-compose, buildah, skopeo, and lazypodman.

- Cgroups v2 enabled.

- K3s (modules/containers/k3s.nix)

- Lightweight Kubernetes for single-node workstations.

- Role: server.

- Optional extra flags to disable Traefik or other services.

- Firewall configured for Kubernetes API (6443).

---

### ğŸ› ï¸ Makefile

#### Common Commands
```bash
make switch           # Rebuild & switch
make switch-impure    # Rebuild & switch using host environment
make build            # Build only
make build-impure     # Build using host environment
```

#### Maintenance
```bash
make rollback
make gc-soft
make gc-hard
```

#### Containers
```bash
make containers-podman   # Switch Docker -> Podman rootless setup
```

#### Diagnostics
```bash
make doctor
```

`make doctor` checks:
- Nix store size
- GC timers
- Disk usage
- Generations
- HM leftovers

---

## ğŸ” Reinstallation Workflow

1. Install NixOS
2. Clone this repo
3. Adjust `hardware-configuration.nix` if needed
4. Run:
```bash
sudo nixos-rebuild switch --flake . --impure
```
5. Restore dotfiles via `stow`

---

## ğŸ§  Design Decisions

- âŒ No Home Manager
- âœ… GNU Stow for dotfiles
- âœ… Aggressive GC (single-user laptop)
- âœ… Clear module boundaries
- âœ… Easy hardware swap
- âœ… Fast boot prioritized over eye candy

---

## ğŸ“š References & Inspiration

- https://github.com/AlexNabokikh/nix-config  
- https://nixos.org/manual  
- https://wiki.nixos.org  

---

## ğŸ Final Notes

This setup is **boring on purpose**. Boring means reliable, fast, reproducible, and easy to throw away and rebuild.

Steal it if you like ğŸ˜„

## v1.1.0

